<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Office Rage)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@300;500;700&family=Noto+Sans+TC:wght@400;700;900&display=swap');

        :root {
            --primary: #e11d48;
            --bg-dark: #050505;
            --panel-bg: rgba(20, 20, 20, 0.95);
            --border-color: rgba(255, 255, 255, 0.15);
            --text-main: #e5e5e5;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden;
            user-select: none;
            margin: 0;
            padding: 0;
            touch-action: none;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            filter: contrast(1.1) brightness(0.9);
        }

        #ui-layer {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 900px;
            z-index: 10;
            background: var(--panel-bg);
            padding: 16px;
            padding-bottom: 30px;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            border-top: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 55vh;
            overflow-y: auto;
        }

        #ui-layer.shaking {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(225, 29, 72, 0.4);
        }

        .deco-line {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.6;
        }

        .weapon-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .weapon-btn {
            position: relative;
            height: 52px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #888;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .weapon-btn:active { transform: scale(0.95); }

        .weapon-btn.active {
            background: rgba(225, 29, 72, 0.15);
            border-color: var(--primary);
            color: #fff;
            box-shadow: inset 0 0 15px rgba(225, 29, 72, 0.2);
        }
        
        .weapon-btn::before {
            content: ''; position: absolute; top: 0; left: 0; width: 0; height: 0;
            border-top: 6px solid var(--primary); border-right: 6px solid transparent;
            opacity: 0; transition: opacity 0.2s;
        }
        .weapon-btn.active::before { opacity: 1; }

        .weapon-label {
            font-size: 0.7rem;
            font-weight: 700;
            margin-top: 1px;
            letter-spacing: 1px;
        }

        .icon-svg { width: 18px; height: 18px; fill: currentColor; }

        .stat-box {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            z-index: 10;
            pointer-events: none;
        }

        .stat-label {
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 0.8rem;
            color: #888;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .damage-number {
            font-family: 'Teko', sans-serif;
            font-size: 3.5rem;
            line-height: 0.9;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 20px rgba(225, 29, 72, 0.5);
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .input-wrapper { position: relative; flex: 1; }

        input {
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
            padding: 12px 16px;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 8px;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 0 1px var(--primary);
        }

        .attack-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 25px;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 1.1rem;
            font-weight: 900;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 15px rgba(225, 29, 72, 0.4);
            white-space: nowrap;
        }

        .attack-btn:active { transform: scale(0.95); }

        .boss-quote-container {
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
            margin-bottom: 4px;
        }

        .quote-tag {
            background: #f59e0b;
            color: #000;
            font-size: 0.75rem;
            font-weight: 900;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Noto Sans TC';
            white-space: nowrap;
        }
        
        .quote-input {
            background: transparent;
            border: none;
            color: #f59e0b;
            font-size: 1rem;
            padding: 4px;
            flex: 1;
            font-weight: 700;
        }
        .quote-input:focus { box-shadow: none; background: rgba(245, 158, 11, 0.1); }

        @media (max-width: 640px) {
            .weapon-grid { gap: 5px; }
            .weapon-btn { height: 50px; border-radius: 6px; }
            .icon-svg { width: 18px; height: 18px; }
            .weapon-label { font-size: 0.65rem; }
            .damage-number { font-size: 2.5rem; }
            #ui-layer { padding: 12px; padding-bottom: 20px; }
            .stat-box { top: 15px; right: 15px; }
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div class="stat-box">
        <div class="stat-label">累積傷害</div>
        <div id="scoreDisplay" class="damage-number">0</div>
        <div class="stat-label" style="margin-top: 5px; color: #f59e0b;">連擊數</div>
        <div id="comboDisplay" style="font-family: 'Teko'; font-size: 2rem; color: #f59e0b; font-weight: 700;">0</div>
    </div>

    <div id="ui-layer">
        <div class="deco-line"></div>
        
        <!-- Boss 廢話設定 -->
        <div class="boss-quote-container">
            <span class="quote-tag">老闆語錄</span>
            <input type="text" id="bossQuoteInput" class="quote-input" value="共體時艱，今年沒年終!" placeholder="輸入老闆語錄...">
            <span class="text-xs text-gray-500 whitespace-nowrap animate-pulse">✎ 點此修改</span>
        </div>

        <!-- 武器選單 (擴充至12個) -->
        <div class="weapon-grid">
            <button onclick="setWeapon('fist')" id="btn-fist" class="weapon-btn active">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M20,11L13,11V7H20V11M20,17L13,17V13H20V17M20,5L13,5V2H20V5M11,6.5L11,18.5C11,19.33 10.33,20 9.5,20H3.5C2.67,20 2,19.33 2,18.5V6.5C2,5.67 2.67,5 3.5,5H9.5C10.33,5 11,5.67 11,6.5Z"/></svg>
                <span class="weapon-label">鐵拳</span>
            </button>
            <button onclick="setWeapon('machinegun')" id="btn-machinegun" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M4 19h2v-2h-2v2zm14-2v-4h-2v-2h-8v-2h-2v10h12zm-8-6h2v2h-2v-2zm-6 8h20v2h-20v-2z"/></svg>
                <span class="weapon-label">連射</span>
            </button>
            <button onclick="setWeapon('axe')" id="btn-axe" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12,2L14.8,4.8L12,7.6V22H10V7.6L7.2,4.8L12,2M12,2L17,7L12,12V2" transform="rotate(45 12 12)" /></svg>
                <span class="weapon-label">飛斧</span>
            </button>
            <button onclick="setWeapon('rain')" id="btn-rain" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M4.5,11L8.5,20L10.5,11M14.5,11L18.5,20L20.5,11M10,3A4,4 0 0,1 14,7A4,4 0 0,1 18,11H5A4,4 0 0,1 9,7A4,4 0 0,1 10,3Z"/></svg>
                <span class="weapon-label">暴雨</span>
            </button>
            
            <button onclick="setWeapon('ice')" id="btn-ice" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12,2L14,7L19,8L15,12L16,17L12,15L8,17L9,12L5,8L10,7L12,2M12,10V14"/></svg>
                <span class="weapon-label">冰錐</span>
            </button>
            <button onclick="setWeapon('fire')" id="btn-fire" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12,19A3,3 0 0,1 9,16C9,14 11,14 11,11C9,11 7,12 7,16A5,5 0 0,0 12,21A5,5 0 0,0 17,16C17,12.5 14,10 12,5C12,9 15,10 15,16A3,3 0 0,1 12,19Z"/></svg>
                <span class="weapon-label">烈火</span>
            </button>
            <button onclick="setWeapon('lightning')" id="btn-lightning" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M7,2V13H10V22L17,10H14L17,2H7Z"/></svg>
                <span class="weapon-label">天雷</span>
            </button>
            <button onclick="setWeapon('poison')" id="btn-poison" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 2C7.58 2 4 4.58 4 8c0 1.25.46 2.41 1.25 3.38C6.68 13.56 8.36 15.69 9 18h6c.64-2.31 2.32-4.44 3.75-6.62.79-.97 1.25-2.13 1.25-3.38 0-3.42-3.58-6-8-6zm-3 7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm6 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg>
                <span class="weapon-label">劇毒</span>
            </button>

            <button onclick="setWeapon('missile')" id="btn-missile" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 2.5l-4 4v11h2l-1 4 3-2 3 2-1-4h2v-11l-4-4z"/></svg>
                <span class="weapon-label">導彈</span>
            </button>
            <button onclick="setWeapon('anvil')" id="btn-anvil" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M2,6H22V10H18V18H6V10H2V6Z"/></svg>
                <span class="weapon-label">重壓</span>
            </button>
            <button onclick="setWeapon('laser')" id="btn-laser" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M13 2L3 13h7v9l10-11h-7z"/></svg>
                <span class="weapon-label">死光</span>
            </button>
            <button onclick="setWeapon('nails')" id="btn-nails" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M11,2L13,4L12.5,14L18,19.5L16.5,21L11,15.5L5.5,21L4,19.5L9.5,14L9,4L11,2Z"/></svg>
                <span class="weapon-label">釘子</span>
            </button>
        </div>

        <div class="control-row">
            <div class="input-wrapper">
                <input type="text" id="insultInput" value="我要加薪!!" placeholder="輸入...">
            </div>
            <button onclick="fireWeapon()" class="attack-btn">發射</button>
        </div>
    </div>

<script>
/**
 * V14.4 錯誤修復版
 * - Fixed: Missing fireWeapon function causing ReferenceError
 * - Includes all 12 weapons and cheer system
 */

const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function initAudio() {
    try {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    } catch(e) { console.warn("Audio init failed", e); }
}

function playSound(type) {
    if (!audioCtx) return;
    try {
        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);

        if (type === 'shoot') {
            osc.frequency.setValueAtTime(120, t);
            osc.frequency.exponentialRampToValueAtTime(40, t+0.1);
            gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.1);
            osc.start(t); osc.stop(t+0.1);
        } else if (type === 'hit') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(100, t);
            osc.frequency.linearRampToValueAtTime(20, t+0.15);
            gain.gain.setValueAtTime(0.3, t); gain.gain.linearRampToValueAtTime(0.001, t+0.15);
            osc.start(t); osc.stop(t+0.15);
        } else if (type === 'explosion') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(50, t);
            osc.frequency.exponentialRampToValueAtTime(10, t+0.8);
            gain.gain.setValueAtTime(0.5, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.8);
            osc.start(t); osc.stop(t+0.8);
        } else if (type === 'thunder') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(80, t);
            osc.frequency.exponentialRampToValueAtTime(20, t+0.5);
            gain.gain.setValueAtTime(0.4, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.5);
            osc.start(t); osc.stop(t+0.5);
        } else if (type === 'fist') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(60, t);
            osc.frequency.exponentialRampToValueAtTime(10, t+0.2);
            gain.gain.setValueAtTime(0.6, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.2);
            osc.start(t); osc.stop(t+0.2);
        } else if (type === 'freeze') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, t);
            osc.frequency.exponentialRampToValueAtTime(200, t+0.3);
            gain.gain.setValueAtTime(0.3, t); gain.gain.linearRampToValueAtTime(0.001, t+0.3);
            osc.start(t); osc.stop(t+0.3);
        } else if (type === 'thud') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(40, t);
            osc.frequency.exponentialRampToValueAtTime(10, t+0.2);
            gain.gain.setValueAtTime(0.5, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.2);
            osc.start(t); osc.stop(t+0.2);
        }
    } catch(e) {}
}

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let width, height;
let score = 0, combo = 0, lastHitTime = 0;
let currentWeapon = 'fist';
let screenShake = 0, flash = 0;
let isMobile = false;

let projectiles = [], particles = [], texts = [], nails = [], effects = [];
let cheerTexts = [];
const cheerPhrases = ["罵得好！", "說得好！", "太棒了！", "爽！", "繼續！", "不要停！", "給力！", "舒壓！", "打得妙！", "解氣！", "好球！", "漂亮！"];

const boss = { 
    x: 0, y: 0, baseY: 0, 
    angle: 0,           
    angularVel: 0,      
    hurt: 0, 
    onFire: 0, 
    poisoned: 0, 
    frozen: 0, 
    recoverTimer: 0,
    quote: "共體時艱，今年沒年終!",
    scale: 1,
    texturePoints: []
};

function generateStaticTexture() {
    boss.texturePoints = [];
    for(let i=0; i<150; i++) {
        boss.texturePoints.push({
            x: Math.random()*90 - 45,
            y: Math.random()*90 - 145,
            size: Math.random() * 2 + 1,
            alpha: Math.random() * 0.1 + 0.05
        });
    }
}
generateStaticTexture();

function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
    isMobile = width < 768;

    boss.scale = isMobile ? 0.9 : 1.0;
    const bottomMargin = isMobile ? 380 : 450;
    boss.baseY = height - bottomMargin;
    
    if (boss.baseY < height * 0.4) boss.baseY = height * 0.55;

    boss.x = width / 2;
    boss.y = boss.baseY;
}
window.addEventListener('resize', resize);
resize();

class Particle {
    constructor(x, y, type) {
        this.x = x; this.y = y;
        this.type = type;
        this.life = 1.0;
        this.decay = Math.random() * 0.02 + 0.01;
        
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 8 + 2;
        
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        
        if (type === 'dust') {
            this.size = Math.random() * 15 + 5;
            this.vx *= 0.3; this.vy *= 0.3;
            this.gravity = -0.01; 
            this.color = `rgba(150, 150, 150, 0.2)`;
            this.decay = 0.03;
        } else if (type === 'debris') {
            this.size = Math.random() * 6 + 2;
            this.gravity = 0.3;
            this.color = Math.random() > 0.5 ? '#92400e' : '#1e293b';
        } else if (type === 'spark') {
            this.size = Math.random() * 4 + 1;
            this.gravity = 0.1;
            this.decay = 0.05;
            this.color = '#fde047';
        } else if (type === 'fire') {
            this.size = Math.random() * 25 + 10;
            this.gravity = -0.3; 
            this.vx = (Math.random() - 0.5) * 3;
            this.vy = -Math.random() * 6 - 2; 
            this.decay = Math.random() * 0.03 + 0.02;
        } else if (type === 'ice') {
            this.size = Math.random() * 5 + 2;
            this.gravity = 0.3; 
            this.color = '#67e8f9'; 
            this.decay = 0.02;
        } else if (type === 'smoke') {
            this.size = Math.random() * 30 + 15;
            this.gravity = -0.05;
            this.vx *= 0.5; this.vy *= 0.5;
            this.color = `rgba(50, 50, 50, 0.5)`;
            this.decay = 0.02;
        } else if (type === 'poison_drip') {
            this.size = Math.random() * 5 + 3;
            this.gravity = 0.2;
            this.vx *= 0.2;
            this.vy = Math.random() * 2;
            this.color = '#a3e635'; 
            this.decay = 0.02;
        } else {
            this.gravity = 0.2;
            this.size = Math.random() * 4 + 2;
            this.color = '#fff';
        }
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        if(this.gravity) this.vy += this.gravity;
        this.life -= this.decay;
        
        if (this.type === 'debris' && this.y > boss.baseY + 50) {
            this.y = boss.baseY + 50;
            this.vy *= -0.5;
            this.vx *= 0.7;
        }
    }
    draw(ctx) {
        if (this.life <= 0) return; 
        ctx.globalAlpha = Math.max(0, this.life);
        
        if (this.type === 'dust' || this.type === 'smoke' || this.type === 'fire') {
            ctx.fillStyle = this.type === 'fire' ? `rgba(255, ${Math.floor(this.life*200)}, 0, ${this.life})` : this.color;
            ctx.beginPath(); 
            const r = Math.max(0, this.size * this.life);
            ctx.arc(this.x, this.y, r, 0, Math.PI*2); 
            ctx.fill();
        } else if (this.type === 'ice' || this.type === 'poison_drip') {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            const r = Math.max(0, this.size);
            ctx.arc(this.x, this.y, r, 0, Math.PI*2);
            ctx.fill();
        } else {
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.size, this.size);
        }
        ctx.globalAlpha = 1;
    }
}

function spawnParticles(x, y, type, count) {
    for(let i=0; i<count; i++) particles.push(new Particle(x, y, type));
}

function drawFistShape(ctx, x, y, size) {
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(size, size);
    ctx.fillStyle = '#dc2626'; 
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0, 0); ctx.lineTo(20, 0); ctx.lineTo(25, 5); ctx.lineTo(25, 25); ctx.lineTo(5, 25); ctx.lineTo(0, 20);
    ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.fillStyle = '#b91c1c'; ctx.fillRect(5, 10, 25, 8); ctx.strokeRect(5, 10, 25, 8);
    ctx.restore();
}

function drawBlockyBoss() {
    ctx.save();
    ctx.translate(boss.x, boss.y);
    ctx.scale(boss.scale, boss.scale);
    ctx.rotate(boss.angle); 

    if(boss.hurt > 0) ctx.translate((Math.random()-0.5)*10, (Math.random()-0.5)*10);

    let suitColor = '#1e293b'; 
    let skinColor = '#fcd34d'; 
    if (boss.frozen > 0) { suitColor = '#0e7490'; skinColor = '#67e8f9'; }
    else if (boss.poisoned > 0) { suitColor = '#365314'; skinColor = '#a3e635'; }

    // Legs
    ctx.fillStyle = '#334155'; 
    ctx.fillRect(-25, -60, 20, 60); 
    ctx.fillRect(5, -60, 20, 60);   

    // Body
    ctx.fillStyle = suitColor;
    ctx.fillRect(-30, -140, 60, 80); 
    ctx.fillStyle = '#ef4444';
    ctx.fillRect(-5, -140, 10, 50);

    // Arms
    ctx.fillStyle = suitColor;
    ctx.fillRect(-50, -140, 20, 70); 
    ctx.fillRect(30, -140, 20, 70);  
    ctx.fillStyle = skinColor;
    ctx.fillRect(-50, -70, 20, 10);
    ctx.fillRect(30, -70, 20, 10);

    // Head
    ctx.fillStyle = skinColor;
    ctx.fillRect(-25, -190, 50, 50); 
    
    // Face
    ctx.fillStyle = '#000';
    if (boss.hurt > 0 || Math.abs(boss.angle) > 1.0) { 
        ctx.font = '30px Arial'; ctx.fillText(">", -15, -165); ctx.fillText("<", 5, -165);
        ctx.fillRect(-10, -155, 20, 5); 
    } else {
        ctx.fillRect(-15, -175, 8, 8); 
        ctx.fillRect(7, -175, 8, 8);   
        ctx.fillRect(-10, -155, 20, 4); 
    }

    if(nails.length > 0) {
        ctx.fillStyle = boss.frozen > 0 ? '#67e8f9' : '#94a3b8';
        nails.forEach(n => {
            ctx.save();
            ctx.translate(n.rx, n.ry); 
            ctx.rotate(n.rot);
            ctx.fillRect(-2, -10, 4, 20);
            ctx.restore();
        });
    }

    ctx.restore();
}

function drawQuote(ctx) {
    if (!boss.quote) return;
    const padding = 15;
    const fontSize = isMobile ? 16 : 18;
    ctx.font = `700 ${fontSize}px 'Noto Sans TC'`;
    const w = Math.min(ctx.measureText(boss.quote).width + padding*2, isMobile ? 200 : 220);
    const h = 50; 

    const headH = 190 * boss.scale;
    const headX = boss.x + Math.sin(boss.angle) * headH;
    const headY = boss.y - Math.cos(boss.angle) * headH;

    let qx = headX + 60;
    let qy = headY - 60;

    if (isMobile) {
        qx = width/2 - w/2; 
        qy = Math.min(headY - 80, height/2 + 50); 
    }
    
    if (qx < 10) qx = 10;
    if (qx + w > width - 10) qx = width - w - 10;

    ctx.fillStyle = '#fff';
    ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 10;
    ctx.beginPath(); ctx.roundRect(qx, qy, w, h, 8); ctx.fill();
    
    ctx.beginPath();
    ctx.moveTo(qx + w/2, qy + h);
    ctx.lineTo(qx + w/2 - 10, qy + h + 10);
    ctx.lineTo(qx + w/2 + 10, qy + h);
    ctx.fill();
    ctx.shadowBlur = 0;

    ctx.fillStyle = '#000'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    let displayQuote = boss.quote;
    const maxChars = isMobile ? 10 : 12;
    if (displayQuote.length > maxChars) displayQuote = displayQuote.substring(0, maxChars) + "...";
    ctx.fillText(displayQuote, qx + w/2, qy + h/2);
}

function spawnCheer() {
    const text = cheerPhrases[Math.floor(Math.random() * cheerPhrases.length)];
    const side = Math.random() > 0.5 ? 1 : -1;
    const offset = 180 + Math.random() * 150; 
    
    let x = width / 2 + side * offset;
    if (x < 50) x = 50;
    if (x > width - 50) x = width - 50;
    
    const y = height * 0.2 + Math.random() * (height * 0.4);
    
    cheerTexts.push({
        x: x,
        y: y,
        text: text,
        life: 1.0,
        vy: 1 + Math.random(),
        scale: 0.5,
        rot: (Math.random() - 0.5) * 0.4
    });
}

function fireWeapon() {
    const txt = document.getElementById('insultInput').value.trim();
    if(!txt) return;
    initAudio();
    
    const sx = width/2; 
    const sy = height - (isMobile ? 220 : 150);
    
    if(currentWeapon === 'machinegun') {
        txt.split('').forEach((c,i) => setTimeout(() => {
            projectiles.push({ x: sx+(Math.random()-0.5)*40, y: sy, vx: (Math.random()-0.5)*5, vy: -20, text: c, type: 'bullet' });
            playSound('shoot');
        }, i*50));
    }
    else if(currentWeapon === 'nails') {
        txt.split('').forEach((c,i) => setTimeout(() => {
            projectiles.push({ x: sx+(Math.random()-0.5)*60, y: sy, vx: (Math.random()-0.5)*10, vy: -25, text: c, type: 'nails', rot: Math.PI/2 });
            playSound('shoot');
        }, i*30));
    }
    else if(currentWeapon === 'axe') {
        projectiles.push({ x: sx, y: sy, vx: (Math.random()-0.5)*15, vy: -25, text: txt, type: 'axe', rot: 0, penetrate: true });
        playSound('shoot');
    }
    else if(currentWeapon === 'missile') {
        projectiles.push({ x: sx, y: sy, vx: 0, vy: -5, text: txt, type: 'missile', color: '#fbbf24' });
        playSound('shoot');
    }
    else if(currentWeapon === 'laser') {
        effects.push({ type:'laser', life:15, x:sx, y:sy, text: txt });
        hitBoss({ type:'laser', damage: 300 });
        flash = 0.5;
        playSound('explosion');
    }
    else if(currentWeapon === 'fire') {
         projectiles.push({ x: sx, y: sy, vx: 0, vy: -12, text: txt, type: 'fire', color: 'orange' });
         playSound('shoot');
    }
    else if(currentWeapon === 'anvil') {
        projectiles.push({ x: boss.x, y: -200, vx: 0, vy: 5, text: txt, type: 'anvil', color: '#94a3b8' });
    }
    else if(currentWeapon === 'lightning') {
        effects.push({ type:'lightning', life:10, text: txt });
        flash = 1.0; screenShake = 30; hitBoss({type:'lightning', damage: 2000});
        playSound('thunder');
    }
    else if(currentWeapon === 'fist') {
        projectiles.push({ x: sx, y: sy, vx: 0, vy: -25, text: txt, type: 'fist', color: '#ef4444' });
        playSound('fist');
    }
    else if(currentWeapon === 'poison') {
        projectiles.push({ x: sx, y: sy, vx: (Math.random()-0.5)*10, vy: -15, text: txt, type: 'poison', color: '#84cc16' });
        playSound('shoot');
    }
    else if(currentWeapon === 'rain') {
        txt.split('').forEach((c,i) => setTimeout(() => {
            projectiles.push({ 
                x: boss.x + (Math.random()-0.5)*200, 
                y: -50, 
                vx: 0, vy: 15 + Math.random()*10, 
                text: c, type: 'rain', color: '#60a5fa' 
            });
            playSound('shoot');
        }, i*50));
    }
    else if(currentWeapon === 'ice') {
        projectiles.push({ x: sx, y: sy, vx: 0, vy: -20, text: txt, type: 'ice', color: '#67e8f9' });
        playSound('shoot');
    }
}

function update() {
    try {
        const g = ctx.createLinearGradient(0, 0, 0, height);
        g.addColorStop(0, '#111'); g.addColorStop(1, '#050505');
        ctx.fillStyle = g; ctx.fillRect(0,0,width,height);
        
        ctx.fillStyle = 'rgba(255,255,255,0.03)';
        ctx.beginPath(); ctx.ellipse(width/2, boss.baseY, 200, 50, 0, 0, Math.PI*2); ctx.fill();

        ctx.save();
        if(screenShake > 0) {
            const amt = screenShake;
            ctx.translate((Math.random()-0.5)*amt, (Math.random()-0.5)*amt);
            screenShake *= 0.9;
        }

        // Physics
        if (boss.recoverTimer > 0) {
            boss.recoverTimer--;
            if(boss.recoverTimer < 30) {
                 boss.angle *= 0.95; 
            }
            else if(Math.abs(boss.angle) < 1.4) {
                 boss.angle += (boss.angle > 0 ? 0.05 : -0.05); 
            }
        } 
        else if (boss.frozen > 0) {
             boss.frozen--;
             boss.angularVel = 0;
        } 
        else {
            const k = 0.02; 
            const damping = 0.95;
            boss.angularVel += -k * boss.angle;
            boss.angularVel *= damping;
            boss.angle += boss.angularVel;
            
            if (boss.angle > 1.5) { 
                boss.angle = 1.5; boss.angularVel = 0; 
                if(boss.recoverTimer <= 0) { boss.recoverTimer = 60; playSound('thud'); screenShake += 5; }
            }
            if (boss.angle < -1.5) { 
                boss.angle = -1.5; boss.angularVel = 0;
                if(boss.recoverTimer <= 0) { boss.recoverTimer = 60; playSound('thud'); screenShake += 5; }
            }
        }

        if(boss.hurt > 0) boss.hurt--;
        
        if(boss.onFire > 0 && boss.frozen <= 0) {
            boss.onFire--;
            const bx = boss.x + Math.sin(boss.angle) * (-100 * boss.scale);
            const by = boss.y - Math.cos(boss.angle) * (100 * boss.scale);
            if(Math.random() > 0.5) particles.push(new Particle(bx + (Math.random()-0.5)*40, by + (Math.random()-0.5)*60, 'fire'));
        }
        if(boss.poisoned > 0) {
            boss.poisoned--;
            if(Math.random() > 0.3) particles.push(new Particle(boss.x + (Math.random()-0.5)*60, boss.y - 100 * boss.scale, 'poison_drip'));
        }
        if(boss.frozen > 0) {
            boss.frozen--;
            if(Math.random() > 0.7) particles.push(new Particle(boss.x + (Math.random()-0.5)*60, boss.y - 100 * boss.scale, 'ice'));
        }

        const shadowW = isMobile ? 80 : 120;
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.beginPath(); 
        ctx.ellipse(boss.x, boss.baseY, shadowW, 15, 0, 0, Math.PI*2); 
        ctx.fill();

        drawBlockyBoss();
        drawQuote(ctx);

        for(let i=projectiles.length-1; i>=0; i--) {
            let p = projectiles[i];
            p.x += p.vx; p.y += p.vy;
            
            if(p.type === 'missile') {
                p.vy *= 1.05;
                if(Math.random() > 0.3) particles.push(new Particle(p.x, p.y, 'smoke'));
            }
            if(p.type === 'anvil') p.vy += 0.5;
            if(p.type === 'axe') { p.rot += 0.3; p.vy += 0.8; }
            if(p.type === 'poison') { p.vy += 0.2; }
            if(p.type === 'rain') { p.vy *= 1.05; }
            if(p.type === 'ice') { p.rot = (p.rot || 0) + 0.1; }

            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot || 0);
            
            if (p.type === 'fist') {
                drawFistShape(ctx, 0, 0, 2.5);
                ctx.rotate(-(p.rot||0));
                ctx.fillStyle = '#fff';
                ctx.font = "900 20px 'Noto Sans TC'";
                ctx.textAlign = 'center';
                ctx.fillText(p.text, 0, -40);
            } else {
                ctx.fillStyle = p.color || '#fff';
                ctx.font = "900 24px 'Noto Sans TC'";
                ctx.textAlign = 'center'; ctx.textBaseline='middle';
                
                if (p.type === 'fire') {
                    const wobble = Math.sin(Date.now()/50) * 5;
                    ctx.translate(wobble, 0);
                    ctx.fillStyle = Math.random() > 0.5 ? '#f97316' : '#facc15'; 
                    ctx.shadowBlur = 20; ctx.shadowColor = '#ef4444';
                    if(Math.random() > 0.3) particles.push(new Particle(p.x + (Math.random()-0.5)*30, p.y, 'fire'));
                }
                
                if (p.type === 'ice') { ctx.shadowBlur = 10; ctx.shadowColor = '#67e8f9'; }
                if (p.type === 'poison') { ctx.fillStyle = '#a3e635'; ctx.shadowBlur = 10; ctx.shadowColor = 'green'; if(Math.random()>0.5) particles.push(new Particle(p.x, p.y, 'poison_drip')); }

                if (p.type !== 'laser_beam' && p.type !== 'fist') ctx.fillText(p.text, 0, 0); 
            }
            
            if(Math.random() > 0.5 && ['fire','missile','poison'].indexOf(p.type) === -1) particles.push(new Particle(p.x, p.y, 'dust'));
            ctx.restore();

            const dist = Math.hypot(p.x - boss.x, p.y - boss.y);
            const threshold = (p.type==='nails'?60:80) * boss.scale;
            
            if(dist < threshold) {
                hitBoss(p);
                if(p.type === 'nails') {
                    const scale = isMobile ? 0.65 : 1.0;
                    nails.push({
                        rx: (p.x - boss.x) / boss.scale, 
                        ry: (p.y - boss.y) / boss.scale, 
                        rot: -boss.angle 
                    });
                    if(nails.length>15) nails.shift();
                }
                if(!p.penetrate) projectiles.splice(i, 1);
            }
            else if(p.y > height+100 || p.y < -500) projectiles.splice(i, 1);
        }

        for(let i=particles.length-1; i>=0; i--) {
            particles[i].update();
            if(particles[i].life <= 0) {
                particles.splice(i,1);
            } else {
                particles[i].draw(ctx);
            }
        }

        for(let i=texts.length-1; i>=0; i--) {
            let t = texts[i];
            t.y -= t.vy; t.vy *= 0.95; t.life -= 0.02;
            if(t.life <= 0) texts.splice(i,1);
            else {
                ctx.save();
                ctx.translate(t.x, t.y);
                const s = 1 + Math.sin(t.life*Math.PI)*0.5;
                ctx.scale(s, s);
                ctx.fillStyle = t.color;
                ctx.shadowColor = t.color; ctx.shadowBlur = 10;
                ctx.font = "900 30px 'Teko'";
                ctx.fillText(t.val, 0, 0);
                ctx.restore();
            }
        }

        for (let i = cheerTexts.length - 1; i >= 0; i--) {
            let c = cheerTexts[i];
            c.y -= c.vy;
            c.life -= 0.015;
            c.scale += 0.005; 
            if (c.life <= 0) {
                cheerTexts.splice(i, 1);
            } else {
                ctx.save();
                ctx.translate(c.x, c.y);
                ctx.scale(c.scale, c.scale);
                ctx.rotate(c.rot);
                ctx.fillStyle = `rgba(255, 215, 0, ${c.life})`; 
                ctx.font = "900 32px 'Noto Sans TC'";
                ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 4;
                ctx.fillText(c.text, 0, 0);
                ctx.restore();
            }
        }

        if(flash > 0) {
            ctx.fillStyle = `rgba(255,255,255,${flash})`;
            ctx.fillRect(0,0,width,height);
            flash *= 0.8;
        }
        
        ctx.restore();

        for (let i = effects.length - 1; i >= 0; i--) {
            let e = effects[i];
            e.life--;
            if(e.type==='laser') {
                ctx.lineWidth = e.life * 2;
                ctx.strokeStyle = '#f43f5e';
                ctx.shadowColor = 'red'; ctx.shadowBlur = 20;
                const cmX = boss.x + Math.sin(boss.angle) * (-100 * boss.scale);
                const cmY = boss.y - Math.cos(boss.angle) * (100 * boss.scale);
                ctx.beginPath(); ctx.moveTo(e.x, e.y); ctx.lineTo(cmX, cmY); ctx.stroke();
                
                ctx.fillStyle = '#fff';
                ctx.font = "900 28px 'Noto Sans TC'";
                ctx.textAlign = 'center';
                ctx.shadowBlur = 10; ctx.shadowColor = 'white';
                const midX = (e.x + boss.x) / 2;
                const midY = (e.y + boss.y) / 2;
                ctx.fillText(e.text, midX, midY);
                ctx.shadowBlur = 0;
            }
            if(e.type==='lightning') {
                ctx.save();
                const shake = Math.random() * 10;
                ctx.translate(boss.x + shake, boss.y - 150 + shake);
                ctx.fillStyle = '#fff';
                ctx.font = "900 50px 'Noto Sans TC'";
                ctx.textAlign = 'center';
                ctx.shadowColor = '#0ea5e9'; ctx.shadowBlur = 30;
                ctx.fillText(e.text, 0, 0);
                ctx.restore();
            }
            if(e.life<=0) effects.splice(i, 1);
        }

        if(Date.now() - lastHitTime > 3000) combo = 0;
        updateUI();

    } catch (err) {
        console.error("Game Loop Error:", err);
    }

    requestAnimationFrame(update);
}

function hitBoss(p) {
    boss.hurt = 10;
    
    const dir = Math.random() > 0.5 ? 1 : -1;
    let impulse = 0.05;
    let dmg = p.damage || 50;
    
    if(p.type === 'fist' || p.type === 'anvil') { impulse = 0.6; dmg = 2500; } 
    else if(p.type === 'missile' || p.type === 'axe') { impulse = 0.3; dmg = 1000; }
    
    if(boss.frozen <= 0) {
        boss.angularVel += impulse * dir;
    }

    lastHitTime = Date.now();
    combo++;

    if (Math.random() < 0.3 + (combo * 0.01)) {
        spawnCheer();
    }

    const cmX = boss.x + Math.sin(boss.angle) * (-100 * boss.scale);
    const cmY = boss.y - Math.cos(boss.angle) * (100 * boss.scale);

    if(p.type === 'missile') { 
        screenShake = 30; playSound('explosion'); 
        spawnParticles(cmX, cmY, 'smoke', 30); spawnParticles(cmX, cmY, 'debris', 15);
    }
    else if(p.type === 'axe') { 
        screenShake = 20; playSound('hit'); spawnParticles(cmX, cmY, 'debris', 10); 
    }
    else if(p.type === 'fire') { 
        playSound('explosion'); spawnParticles(cmX, cmY, 'fire', 40); 
        boss.onFire = 120; boss.frozen = 0;
    }
    else if(p.type === 'fist') {
        screenShake = 50; playSound('hit');
        spawnParticles(cmX, cmY, 'dust', 30); spawnParticles(cmX, cmY, 'debris', 10);
    }
    else if(p.type === 'poison') {
        dmg = 300; boss.poisoned = 180; playSound('hit');
        spawnParticles(cmX, cmY, 'poison_drip', 10);
    }
    else if(p.type === 'ice') {
        dmg = 600; playSound('freeze'); boss.frozen = 180; boss.onFire = 0;
        spawnParticles(cmX, cmY, 'ice', 20);
    }
    else if (p.type === 'anvil') {
        screenShake = 40; playSound('hit'); spawnParticles(cmX, cmY, 'dust', 20);
    }
    else { playSound('hit'); spawnParticles(cmX, cmY, 'dust', 5); }

    if(p.type !== 'fire' && p.type !== 'missile' && p.type !== 'poison' && p.type !== 'ice') {
        spawnParticles(boss.x, boss.y - 50, 'dust', 3);
    }

    score += dmg;
    texts.push({ x: boss.x+(Math.random()-0.5)*100, y: boss.y-150, val: dmg, color: '#e11d48', vy: 5, life: 1.0 });

    const ui = document.getElementById('ui-layer');
    ui.classList.add('shaking'); setTimeout(()=>ui.classList.remove('shaking'), 100);
}

function updateUI() {
    document.getElementById('scoreDisplay').innerText = score.toLocaleString();
    const c = document.getElementById('comboDisplay');
    c.innerText = combo > 0 ? `x${combo}` : '';
    c.style.opacity = combo > 0 ? 1 : 0;
}

function setWeapon(w) {
    currentWeapon = w;
    document.querySelectorAll('.weapon-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-'+w).classList.add('active');
}

document.getElementById('insultInput').addEventListener('keydown', e => { if(e.key==='Enter') fireWeapon() });
document.getElementById('bossQuoteInput').addEventListener('input', e => boss.quote = e.target.value);
document.addEventListener('mousedown', initAudio);
document.addEventListener('touchstart', initAudio);

update();
</script>
</body>
</html>