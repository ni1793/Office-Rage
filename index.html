<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>職場發洩室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@300;500;700&family=Noto+Sans+TC:wght@400;700;900&display=swap');

        :root {
            --primary: #e11d48;
            --bg-dark: #050505;
            --panel-bg: rgba(20, 20, 20, 0.9);
            --border-color: rgba(255, 255, 255, 0.15);
            --text-main: #e5e5e5;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden;
            user-select: none;
            margin: 0;
            padding: 0;
            touch-action: none;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            filter: contrast(1.1) brightness(0.9);
        }

        #ui-layer {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 900px;
            z-index: 10;
            background: var(--panel-bg);
            padding: 20px;
            padding-bottom: 30px;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            border-top: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #ui-layer.shaking {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(225, 29, 72, 0.4);
        }

        .deco-line {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.6;
        }

        .weapon-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .weapon-btn {
            position: relative;
            height: 60px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #888;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .weapon-btn:active { transform: scale(0.95); }

        .weapon-btn.active {
            background: rgba(225, 29, 72, 0.15);
            border-color: var(--primary);
            color: #fff;
            box-shadow: inset 0 0 15px rgba(225, 29, 72, 0.2);
        }
        
        .weapon-btn::before {
            content: ''; position: absolute; top: 0; left: 0; width: 0; height: 0;
            border-top: 6px solid var(--primary); border-right: 6px solid transparent;
            opacity: 0; transition: opacity 0.2s;
        }
        .weapon-btn.active::before { opacity: 1; }

        .weapon-label {
            font-size: 0.8rem;
            font-weight: 700;
            margin-top: 2px;
            letter-spacing: 1px;
        }

        .icon-svg { width: 22px; height: 22px; fill: currentColor; }

        .stat-box {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            z-index: 10;
            pointer-events: none;
        }

        .stat-label {
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 0.8rem;
            color: #888;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .damage-number {
            font-family: 'Teko', sans-serif;
            font-size: 3.5rem;
            line-height: 0.9;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 20px rgba(225, 29, 72, 0.5);
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .input-wrapper { position: relative; flex: 1; }

        input {
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
            padding: 12px 16px;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 8px;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 0 1px var(--primary);
        }

        .attack-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 25px;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 1.1rem;
            font-weight: 900;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 15px rgba(225, 29, 72, 0.4);
            white-space: nowrap;
        }

        .attack-btn:active { transform: scale(0.95); }

        .boss-quote-container {
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
            margin-bottom: 5px;
        }

        .quote-tag {
            background: #f59e0b;
            color: #000;
            font-size: 0.75rem;
            font-weight: 900;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Noto Sans TC';
            white-space: nowrap;
        }
        
        .quote-input {
            background: transparent;
            border: none;
            color: #f59e0b;
            font-size: 1rem;
            padding: 4px;
            flex: 1;
            font-weight: 700;
        }
        .quote-input:focus { box-shadow: none; background: rgba(245, 158, 11, 0.1); }

        @media (max-width: 640px) {
            .weapon-grid { gap: 6px; }
            .weapon-btn { height: 55px; border-radius: 6px; }
            .icon-svg { width: 18px; height: 18px; }
            .weapon-label { font-size: 0.7rem; }
            .damage-number { font-size: 2.5rem; }
            #ui-layer { padding: 15px; padding-bottom: 25px; }
            .stat-box { top: 15px; right: 15px; }
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div class="stat-box">
        <div class="stat-label">累積傷害</div>
        <div id="scoreDisplay" class="damage-number">0</div>
        <div class="stat-label" style="margin-top: 5px; color: #f59e0b;">連擊數</div>
        <div id="comboDisplay" style="font-family: 'Teko'; font-size: 2rem; color: #f59e0b; font-weight: 700;">0</div>
    </div>

    <div id="ui-layer">
        <div class="deco-line"></div>
        
        <!-- Boss 廢話設定 -->
        <div class="boss-quote-container">
            <span class="quote-tag">老闆語錄</span>
            <input type="text" id="bossQuoteInput" class="quote-input" value="共體時艱，今年沒年終!" placeholder="輸入老闆語錄...">
            <!-- 新增提示 -->
            <span class="text-xs text-gray-500 whitespace-nowrap animate-pulse">✎ 點此修改</span>
        </div>

        <!-- 武器選單 -->
        <div class="weapon-grid">
            <button onclick="setWeapon('machinegun')" id="btn-machinegun" class="weapon-btn active">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M4 19h2v-2h-2v2zm14-2v-4h-2v-2h-8v-2h-2v10h12zm-8-6h2v2h-2v-2zm-6 8h20v2h-20v-2z"/></svg>
                <span class="weapon-label">連射</span>
            </button>
            <button onclick="setWeapon('nails')" id="btn-nails" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M11,2L13,4L12.5,14L18,19.5L16.5,21L11,15.5L5.5,21L4,19.5L9.5,14L9,4L11,2Z"/></svg>
                <span class="weapon-label">釘子</span>
            </button>
            <button onclick="setWeapon('axe')" id="btn-axe" class="weapon-btn">
                <!-- 斧頭 Icon -->
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12,2L14.8,4.8L12,7.6V22H10V7.6L7.2,4.8L12,2M12,2L17,7L12,12V2" transform="rotate(45 12 12)" /></svg>
                <span class="weapon-label">飛斧</span>
            </button>
            <button onclick="setWeapon('laser')" id="btn-laser" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M13 2L3 13h7v9l10-11h-7z"/></svg>
                <span class="weapon-label">死光</span>
            </button>
            
            <button onclick="setWeapon('missile')" id="btn-missile" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 2.5l-4 4v11h2l-1 4 3-2 3 2-1-4h2v-11l-4-4z"/></svg>
                <span class="weapon-label">導彈</span>
            </button>
            <button onclick="setWeapon('fire')" id="btn-fire" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12,19A3,3 0 0,1 9,16C9,14 11,14 11,11C9,11 7,12 7,16A5,5 0 0,0 12,21A5,5 0 0,0 17,16C17,12.5 14,10 12,5C12,9 15,10 15,16A3,3 0 0,1 12,19Z"/></svg>
                <span class="weapon-label">烈火</span>
            </button>
            <button onclick="setWeapon('anvil')" id="btn-anvil" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M2,6H22V10H18V18H6V10H2V6Z"/></svg>
                <span class="weapon-label">重壓</span>
            </button>
            <button onclick="setWeapon('lightning')" id="btn-lightning" class="weapon-btn">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M7,2V13H10V22L17,10H14L17,2H7Z"/></svg>
                <span class="weapon-label">天雷</span>
            </button>
        </div>

        <div class="control-row">
            <div class="input-wrapper">
                <input type="text" id="insultInput" value="我要加薪!!" placeholder="輸入...">
            </div>
            <button onclick="fireWeapon()" class="attack-btn">發射</button>
        </div>
    </div>

<script>
/**
 * V10.2 語錄提示版
 * - 加入語錄可修改提示
 */

// --- Audio ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function initAudio() {
    try {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    } catch(e) { console.warn("Audio init failed", e); }
}

function playSound(type) {
    if (!audioCtx) return;
    try {
        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);

        if (type === 'shoot') {
            osc.frequency.setValueAtTime(120, t);
            osc.frequency.exponentialRampToValueAtTime(40, t+0.1);
            gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.1);
            osc.start(t); osc.stop(t+0.1);
        } else if (type === 'hit') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(100, t);
            osc.frequency.linearRampToValueAtTime(20, t+0.15);
            gain.gain.setValueAtTime(0.3, t); gain.gain.linearRampToValueAtTime(0.001, t+0.15);
            osc.start(t); osc.stop(t+0.15);
        } else if (type === 'explosion') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(50, t);
            osc.frequency.exponentialRampToValueAtTime(10, t+0.8);
            gain.gain.setValueAtTime(0.5, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.8);
            osc.start(t); osc.stop(t+0.8);
        } else if (type === 'thunder') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(80, t);
            osc.frequency.exponentialRampToValueAtTime(20, t+0.5);
            gain.gain.setValueAtTime(0.4, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.5);
            osc.start(t); osc.stop(t+0.5);
        }
    } catch(e) {}
}

// --- Constants & State ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let width, height;
let score = 0, combo = 0, lastHitTime = 0;
let currentWeapon = 'machinegun';
let screenShake = 0, flash = 0;
let isMobile = false;

let projectiles = [], particles = [], texts = [], nails = [], effects = [];

// Boss 初始化
const boss = { 
    x: 0, y: 0, baseY: 0, 
    vx: 0, vy: 0, rot: 0, 
    hurt: 0, 
    quote: "共體時艱，今年沒年終!",
    texturePoints: []
};

// 預先生成靜態紋理
function generateStaticTexture() {
    boss.texturePoints = [];
    for(let i=0; i<150; i++) {
        boss.texturePoints.push({
            x: Math.random()*90 - 45,
            y: Math.random()*90 - 145,
            size: Math.random() * 2 + 1,
            alpha: Math.random() * 0.1 + 0.05
        });
    }
}
generateStaticTexture();

// --- Initialization ---
function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
    isMobile = width < 768;
    boss.baseY = height / 2 - (isMobile ? 0 : 50); 
    boss.x = width / 2;
    boss.y = boss.baseY;
}
window.addEventListener('resize', resize);
resize();

// --- Particle Class ---
class Particle {
    constructor(x, y, type) {
        this.x = x; this.y = y;
        this.type = type;
        this.life = 1.0;
        this.decay = Math.random() * 0.02 + 0.01;
        
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 8 + 2;
        
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        
        if (type === 'dust') {
            this.size = Math.random() * 15 + 5;
            this.vx *= 0.3; this.vy *= 0.3;
            this.gravity = -0.01; 
            this.color = `rgba(150, 150, 150, 0.2)`;
            this.decay = 0.03;
        } else if (type === 'debris') {
            this.size = Math.random() * 6 + 2;
            this.gravity = 0.3;
            this.color = Math.random() > 0.5 ? '#92400e' : '#1e293b';
        } else if (type === 'spark') {
            this.size = Math.random() * 4 + 1;
            this.gravity = 0.1;
            this.decay = 0.05;
            this.color = '#fde047';
        } else if (type === 'fire') {
            // 火焰粒子向上飄
            this.size = Math.random() * 20 + 10; // 大一點
            this.gravity = -0.3; // 負重力，向上飄
            this.vx = (Math.random() - 0.5) * 4; // 左右飄動
            this.vy = -Math.random() * 5; // 初始向上速度
            this.decay = Math.random() * 0.04 + 0.02;
            // 顏色稍後在 draw 處理
        } else {
            this.gravity = 0.2;
            this.size = Math.random() * 4 + 2;
            this.color = '#fff';
        }
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        if(this.gravity) this.vy += this.gravity;
        this.life -= this.decay;
        
        if (this.type === 'debris' && this.y > boss.baseY + 180) {
            this.y = boss.baseY + 180;
            this.vy *= -0.5;
            this.vx *= 0.7;
        }
    }
    draw(ctx) {
        if (this.life <= 0) return; 
        ctx.globalAlpha = Math.max(0, this.life);
        
        if (this.type === 'dust') {
            ctx.fillStyle = this.color;
            ctx.beginPath(); 
            const r = Math.max(0, this.size * this.life);
            ctx.arc(this.x, this.y, r, 0, Math.PI*2); 
            ctx.fill();
        } else if (this.type === 'fire') {
            // 火焰顏色漸變：黃 -> 橘 -> 紅 -> 透明
            const r = 255;
            const g = Math.floor(Math.max(0, this.life * 200)); // 隨生命減少變紅
            const b = 0;
            ctx.fillStyle = `rgba(${r},${g},${b},${this.life})`;
            ctx.beginPath();
            const radius = Math.max(0, this.size * this.life);
            ctx.arc(this.x, this.y, radius, 0, Math.PI*2);
            ctx.fill();
        } else {
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.size, this.size);
        }
        ctx.globalAlpha = 1;
    }
}

function spawnParticles(x, y, type, count) {
    for(let i=0; i<count; i++) particles.push(new Particle(x, y, type));
}

// --- Drawing Functions ---
function drawScarecrow() {
    ctx.save();
    ctx.translate(boss.x, boss.y);
    const s = isMobile ? 0.65 : 1.0;
    ctx.scale(s, s);
    ctx.rotate(boss.rot);
    if(boss.hurt > 0) ctx.translate((Math.random()-0.5)*15, (Math.random()-0.5)*15);

    // 背後木架
    ctx.fillStyle = '#3e2c26'; 
    ctx.fillRect(-12, -60, 24, 200); 
    ctx.fillRect(-90, -50, 180, 18); 
    ctx.strokeStyle = '#281b16'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(-6, -60); ctx.lineTo(-6, 140); ctx.stroke();
    
    // 西裝身體
    ctx.fillStyle = '#1e293b'; 
    ctx.beginPath();
    ctx.moveTo(-60, -50); ctx.lineTo(60, -50); 
    ctx.bezierCurveTo(70, -20, 75, 50, 65, 90); ctx.lineTo(0, 100); ctx.lineTo(-65, 90);
    ctx.bezierCurveTo(-75, 50, -70, -20, -60, -50); ctx.fill();

    ctx.save(); ctx.clip();
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx.lineWidth = 1;
    for(let i=-60; i<60; i+=8) { ctx.beginPath(); ctx.moveTo(i, -50); ctx.lineTo(i, 100); ctx.stroke(); }
    ctx.restore();

    ctx.fillStyle = '#334155'; ctx.fillRect(20, 40, 25, 25);
    ctx.strokeStyle = '#94a3b8'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(22,40); ctx.lineTo(22,65); ctx.stroke();

    ctx.fillStyle = '#e2e8f0'; 
    ctx.beginPath(); ctx.moveTo(0, -50); ctx.lineTo(20, -20); ctx.lineTo(0, 10); ctx.lineTo(-20, -20); ctx.fill();
    ctx.fillStyle = '#be123c'; 
    ctx.beginPath(); ctx.moveTo(0, -45); ctx.lineTo(10, -15); ctx.lineTo(0, 50); ctx.lineTo(-10, -15); ctx.fill();

    const headGrad = ctx.createRadialGradient(-10, -100, 5, 0, -100, 50);
    headGrad.addColorStop(0, '#fbbf24'); headGrad.addColorStop(1, '#92400e'); 
    ctx.fillStyle = headGrad;
    ctx.beginPath();
    ctx.moveTo(-35, -70); ctx.bezierCurveTo(-50, -80, -50, -140, 0, -145); 
    ctx.bezierCurveTo(50, -140, 50, -80, 35, -70); ctx.fill();

    ctx.save(); ctx.clip();
    boss.texturePoints.forEach(p => {
        ctx.fillStyle = `rgba(0,0,0,${p.alpha})`;
        ctx.fillRect(p.x, p.y, p.size, p.size);
    });
    ctx.restore();

    ctx.strokeStyle = '#713f12'; ctx.lineWidth = 6;
    ctx.beginPath(); ctx.moveTo(-34, -72); ctx.quadraticCurveTo(0, -60, 34, -72); ctx.stroke();

    ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    ctx.fillStyle = '#1a1a1a'; ctx.strokeStyle = '#1a1a1a';

    if (boss.hurt > 0) {
        ctx.lineWidth = 4;
        ctx.beginPath(); ctx.arc(-20, -110, 8, 0, Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.arc(20, -110, 8, 0, Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.ellipse(0, -85, 10, 15, 0, 0, Math.PI*2); ctx.fill();
    } else {
        ctx.beginPath(); ctx.arc(-20, -110, 8, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(20, -110, 8, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#555'; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(-22,-110); ctx.lineTo(-18,-110); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(-20,-112); ctx.lineTo(-20,-108); ctx.stroke();
        
        ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.moveTo(-30, -125); ctx.lineTo(-10, -118); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(30, -125); ctx.lineTo(10, -118); ctx.stroke();

        ctx.beginPath(); ctx.moveTo(-20, -85); ctx.quadraticCurveTo(0, -75, 20, -85); ctx.stroke();
        ctx.lineWidth = 2;
        for(let x=-15; x<=15; x+=7) {
            ctx.beginPath(); ctx.moveTo(x, -90); ctx.lineTo(x, -80); ctx.stroke();
        }
    }

    nails.forEach(n => {
        ctx.save();
        ctx.translate(n.ox, n.oy);
        ctx.rotate(n.rot);
        ctx.fillStyle = '#94a3b8';
        ctx.fillRect(-2, -15, 4, 30); 
        ctx.fillStyle = '#ef4444'; 
        ctx.beginPath(); ctx.arc(0, -15, 5, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    });

    ctx.restore();
}

function drawQuote(ctx) {
    if (!boss.quote) return;
    const padding = 15;
    const fontSize = isMobile ? 16 : 18;
    ctx.font = `700 ${fontSize}px 'Noto Sans TC'`;
    const w = Math.min(ctx.measureText(boss.quote).width + padding*2, isMobile ? 200 : 220);
    const h = 50; 

    let qx = boss.x + 80;
    let qy = boss.y - 180 + Math.sin(Date.now()/500)*5;

    if (isMobile) {
        qx = width / 2 - w / 2;
        qy = boss.y - 160; 
        if (qy < 90) qy = 90;
    }

    if (qx < 10) qx = 10;
    if (qx + w > width - 10) qx = width - w - 10;

    ctx.fillStyle = '#fff';
    ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 20;
    ctx.beginPath();
    ctx.roundRect(qx, qy, w, h, 8);
    ctx.fill();
    
    let tailX = qx + w/2;
    if (tailX < boss.x - 20) tailX = qx + w - 20; 
    if (tailX > boss.x + 20) tailX = qx + 20; 
    
    ctx.beginPath();
    ctx.moveTo(tailX, qy + h);
    ctx.lineTo(tailX - 10, qy + h + 15);
    ctx.lineTo(tailX + 10, qy + h);
    ctx.fill();
    ctx.shadowBlur = 0;

    ctx.fillStyle = '#000'; 
    ctx.textAlign = 'center'; 
    ctx.textBaseline = 'middle';
    
    let displayQuote = boss.quote;
    const maxChars = isMobile ? 10 : 12;
    if (displayQuote.length > maxChars) displayQuote = displayQuote.substring(0, maxChars) + "...";

    ctx.fillText(displayQuote, qx + w/2, qy + h/2);
}

// --- Game Logic ---
function update() {
    try {
        const g = ctx.createLinearGradient(0, 0, 0, height);
        g.addColorStop(0, '#111'); g.addColorStop(1, '#050505');
        ctx.fillStyle = g; ctx.fillRect(0,0,width,height);
        
        ctx.fillStyle = 'rgba(255,255,255,0.03)';
        ctx.beginPath(); ctx.ellipse(width/2, height/2+50, 200, 200, 0, 0, Math.PI*2); ctx.fill();

        ctx.save();
        if(screenShake > 0) {
            const amt = screenShake;
            ctx.translate((Math.random()-0.5)*amt, (Math.random()-0.5)*amt);
            screenShake *= 0.9;
        }

        boss.x += (width/2 - boss.x) * 0.1;
        boss.y += (boss.baseY - boss.y) * 0.1;
        boss.rot *= 0.9;
        if(boss.hurt > 0) boss.hurt--;

        const shadowW = isMobile ? 80 : 120;
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.beginPath(); 
        ctx.ellipse(boss.x, boss.baseY + (isMobile? 130 : 190), shadowW, 20, 0, 0, Math.PI*2); 
        ctx.fill();

        drawScarecrow();
        drawQuote(ctx);

        // Projectiles Loop
        for(let i=projectiles.length-1; i>=0; i--) {
            let p = projectiles[i];
            p.x += p.vx; p.y += p.vy;
            
            if(p.type === 'missile') p.vy *= 1.05;
            if(p.type === 'anvil') p.vy += 0.5;
            if(p.type === 'axe') {
                p.rot += 0.3;
                p.vy += 0.8; // Gravity for axe
            }

            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot || 0);
            
            // Text Drawing
            ctx.fillStyle = p.color || '#fff';
            ctx.font = "900 24px 'Noto Sans TC'";
            ctx.textAlign = 'center'; ctx.textBaseline='middle';
            
            // Fire Logic: Wobbly text & Trails
            if (p.type === 'fire') {
                const wobble = Math.sin(Date.now()/50) * 5;
                ctx.translate(wobble, 0);
                // 閃爍顏色
                ctx.fillStyle = Math.random() > 0.5 ? '#f97316' : '#facc15'; 
                ctx.shadowBlur = 20; ctx.shadowColor = '#ef4444';
                
                // 產生火焰拖尾
                if(Math.random() > 0.3) {
                    particles.push(new Particle(p.x + (Math.random()-0.5)*30, p.y, 'fire'));
                }
            }

            if (p.type !== 'laser_beam') ctx.fillText(p.text, 0, 0); 
            
            if(Math.random() > 0.5 && p.type !== 'fire') particles.push(new Particle(p.x, p.y, 'dust'));
            ctx.restore();

            const dist = Math.hypot(p.x - boss.x, p.y - boss.y);
            const threshold = (p.type==='nails'?60:80) * (isMobile ? 0.7 : 1);
            
            if(dist < threshold) {
                hitBoss(p);
                if(p.type === 'nails') {
                    const scale = isMobile ? 0.65 : 1.0;
                    nails.push({
                        ox: (p.x-boss.x) / scale, 
                        oy: (p.y-boss.y) / scale, 
                        rot: (Math.random()-0.5)+Math.PI/2
                    });
                    if(nails.length>15) nails.shift();
                }
                if(!p.penetrate) projectiles.splice(i, 1);
            }
            else if(p.y > height+100 || p.y < -500) projectiles.splice(i, 1);
        }

        // Particles Loop
        for(let i=particles.length-1; i>=0; i--) {
            particles[i].update();
            if(particles[i].life <= 0) {
                particles.splice(i,1);
            } else {
                particles[i].draw(ctx);
            }
        }

        // Texts Loop
        for(let i=texts.length-1; i>=0; i--) {
            let t = texts[i];
            t.y -= t.vy; t.vy *= 0.95; t.life -= 0.02;
            if(t.life <= 0) texts.splice(i,1);
            else {
                ctx.save();
                ctx.translate(t.x, t.y);
                const s = 1 + Math.sin(t.life*Math.PI)*0.5;
                ctx.scale(s, s);
                ctx.fillStyle = t.color;
                ctx.shadowColor = t.color; ctx.shadowBlur = 10;
                ctx.font = "900 30px 'Teko'";
                ctx.fillText(t.val, 0, 0);
                ctx.restore();
            }
        }

        if(flash > 0) {
            ctx.fillStyle = `rgba(255,255,255,${flash})`;
            ctx.fillRect(0,0,width,height);
            flash *= 0.8;
        }
        
        ctx.restore();

        // Effects Loop (Safe Reverse Loop)
        for (let i = effects.length - 1; i >= 0; i--) {
            let e = effects[i];
            e.life--;
            if(e.type==='laser') {
                // Laser beam
                ctx.lineWidth = e.life * 2;
                ctx.strokeStyle = '#f43f5e';
                ctx.shadowColor = 'red'; ctx.shadowBlur = 20;
                ctx.beginPath(); ctx.moveTo(e.x, e.y); ctx.lineTo(boss.x, boss.y); ctx.stroke();
                
                // Draw text in the middle of laser
                ctx.fillStyle = '#fff';
                ctx.font = "900 28px 'Noto Sans TC'";
                ctx.textAlign = 'center';
                ctx.shadowBlur = 10; ctx.shadowColor = 'white';
                const midX = (e.x + boss.x) / 2;
                const midY = (e.y + boss.y) / 2;
                ctx.fillText(e.text, midX, midY);
                
                ctx.shadowBlur = 0;
            }
            if(e.type==='lightning') {
                // Lightning flash text
                ctx.save();
                const shake = Math.random() * 10;
                ctx.translate(boss.x + shake, boss.y - 150 + shake);
                ctx.fillStyle = '#fff';
                ctx.font = "900 50px 'Noto Sans TC'";
                ctx.textAlign = 'center';
                ctx.shadowColor = '#0ea5e9'; ctx.shadowBlur = 30;
                ctx.fillText(e.text, 0, 0);
                ctx.restore();
            }
            if(e.life<=0) effects.splice(i, 1);
        }

        if(Date.now() - lastHitTime > 3000) combo = 0;
        updateUI();

    } catch (err) {
        console.error("Game Loop Error:", err);
    }

    requestAnimationFrame(update);
}

function fireWeapon() {
    const txt = document.getElementById('insultInput').value.trim();
    if(!txt) return;
    initAudio();
    
    const sx = width/2; 
    const sy = height - (isMobile ? 220 : 150);
    
    if(currentWeapon === 'machinegun') {
        txt.split('').forEach((c,i) => setTimeout(() => {
            projectiles.push({ x: sx+(Math.random()-0.5)*40, y: sy, vx: (Math.random()-0.5)*5, vy: -20, text: c, type: 'bullet' });
            playSound('shoot');
        }, i*50));
    }
    else if(currentWeapon === 'nails') {
        txt.split('').forEach((c,i) => setTimeout(() => {
            projectiles.push({ x: sx+(Math.random()-0.5)*60, y: sy, vx: (Math.random()-0.5)*10, vy: -25, text: c, type: 'nails', rot: Math.PI/2 });
            playSound('shoot');
        }, i*30));
    }
    else if(currentWeapon === 'axe') {
        // "Throw" the text as a block
        projectiles.push({ x: sx, y: sy, vx: (Math.random()-0.5)*15, vy: -25, text: txt, type: 'axe', rot: 0, penetrate: true });
        playSound('shoot');
    }
    else if(currentWeapon === 'missile') {
        projectiles.push({ x: sx, y: sy, vx: 0, vy: -5, text: txt, type: 'missile', color: '#f59e0b' });
        playSound('shoot');
    }
    else if(currentWeapon === 'laser') {
        effects.push({ type:'laser', life:15, x:sx, y:sy, text: txt });
        hitBoss({ type:'laser', damage: 300 });
        flash = 0.5;
        playSound('explosion');
    }
    else if(currentWeapon === 'fire') {
         projectiles.push({ x: sx, y: sy, vx: 0, vy: -12, text: txt, type: 'fire', color: 'orange' });
         playSound('shoot');
    }
    else if(currentWeapon === 'anvil') {
        projectiles.push({ x: boss.x, y: -200, vx: 0, vy: 5, text: txt, type: 'anvil', color: '#94a3b8' });
    }
    else if(currentWeapon === 'lightning') {
        effects.push({ type:'lightning', life:10, text: txt });
        flash = 1.0; screenShake = 30; hitBoss({type:'lightning', damage: 2000});
        playSound('thunder');
    }
}

function hitBoss(p) {
    boss.hurt = 10;
    boss.vx = (Math.random()-0.5)*20;
    boss.vy = (Math.random()-0.5)*20;
    boss.rot = (Math.random()-0.5)*0.5;
    lastHitTime = Date.now();
    combo++;

    let dmg = p.damage || 50;
    if(p.type === 'missile') { dmg = 1500; screenShake = 30; playSound('explosion'); spawnParticles(boss.x, boss.y, 'fire', 50); }
    else if(p.type === 'axe') { dmg = 800; screenShake = 20; playSound('hit'); spawnParticles(boss.x, boss.y, 'debris', 10); }
    else if(p.type === 'anvil') { dmg = 1000; screenShake = 20; playSound('hit'); boss.y += 100; }
    else if(p.type === 'fire') { 
        dmg = 500; 
        playSound('explosion'); 
        spawnParticles(boss.x, boss.y, 'fire', 30); // 擊中燃燒！
    }
    else { playSound('hit'); spawnParticles(boss.x, boss.y, 'dust', 5); }

    spawnParticles(boss.x, boss.y - 50, 'debris', 8);
    spawnParticles(boss.x, boss.y - 50, 'spark', 5);

    score += dmg;
    texts.push({ x: boss.x+(Math.random()-0.5)*100, y: boss.y-100, val: dmg, color: '#e11d48', vy: 5, life: 1.0 });

    const ui = document.getElementById('ui-layer');
    ui.classList.add('shaking'); setTimeout(()=>ui.classList.remove('shaking'), 100);
}

function updateUI() {
    document.getElementById('scoreDisplay').innerText = score.toLocaleString();
    const c = document.getElementById('comboDisplay');
    c.innerText = combo > 0 ? `x${combo}` : '';
    c.style.opacity = combo > 0 ? 1 : 0;
}

function setWeapon(w) {
    currentWeapon = w;
    document.querySelectorAll('.weapon-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-'+w).classList.add('active');
}

document.getElementById('insultInput').addEventListener('keydown', e => { if(e.key==='Enter') fireWeapon() });
document.getElementById('bossQuoteInput').addEventListener('input', e => boss.quote = e.target.value);
document.addEventListener('mousedown', initAudio);
document.addEventListener('touchstart', initAudio);

// Start
update();
</script>
</body>
</html>